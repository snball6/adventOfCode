
const scoresJson = { "members": { "1236060": { "local_score": 0, "id": "1236060", "name": "Giovanni Sturla", "last_star_ts": "0", "global_score": 0, "stars": 0, "completion_day_level": {} }, "1727519": { "completion_day_level": { "4": { "1": { "get_star_ts": 1638681139 }, "2": { "get_star_ts": 1638681356 } }, "2": { "2": { "get_star_ts": 1638497354 }, "1": { "get_star_ts": 1638496234 } }, "3": { "2": { "get_star_ts": 1638513824 }, "1": { "get_star_ts": 1638512313 } }, "7": { "2": { "get_star_ts": 1638853947 }, "1": { "get_star_ts": 1638853790 } }, "6": { "1": { "get_star_ts": 1638811172 }, "2": { "get_star_ts": 1638811208 } }, "1": { "2": { "get_star_ts": 1638454522 }, "1": { "get_star_ts": 1638454097 } }, "5": { "1": { "get_star_ts": 1638761056 }, "2": { "get_star_ts": 1638762771 } }, "8": { "2": { "get_star_ts": 1638979007 }, "1": { "get_star_ts": 1638976311 } } }, "global_score": 0, "stars": 16, "last_star_ts": 1638979007, "name": "Murtuza Boxwala", "id": "1727519", "local_score": 248 }, "1536781": { "completion_day_level": { "1": { "1": { "get_star_ts": 1638372149 }, "2": { "get_star_ts": 1638378029 } }, "2": { "2": { "get_star_ts": 1638462660 }, "1": { "get_star_ts": 1638459485 } } }, "global_score": 0, "stars": 4, "last_star_ts": 1638462660, "name": "MitchZo", "id": "1536781", "local_score": 69 }, "1108809": { "stars": 4, "global_score": 0, "completion_day_level": { "2": { "1": { "get_star_ts": 1638585499 }, "2": { "get_star_ts": 1638586544 } }, "1": { "1": { "get_star_ts": 1638583910 }, "2": { "get_star_ts": 1638584322 } } }, "local_score": 27, "id": "1108809", "last_star_ts": 1638586544, "name": "Scott Krumrei" }, "1032152": { "global_score": 0, "stars": 12, "completion_day_level": { "5": { "2": { "get_star_ts": 1638903065 }, "1": { "get_star_ts": 1638891688 } }, "6": { "2": { "get_star_ts": 1638909999 }, "1": { "get_star_ts": 1638909961 } }, "4": { "2": { "get_star_ts": 1638822590 }, "1": { "get_star_ts": 1638821862 } }, "1": { "1": { "get_star_ts": 1638393039 }, "2": { "get_star_ts": 1638393565 } }, "2": { "2": { "get_star_ts": 1638466033 }, "1": { "get_star_ts": 1638464807 } }, "3": { "2": { "get_star_ts": 1638734524 }, "1": { "get_star_ts": 1638539275 } } }, "local_score": 171, "id": "1032152", "last_star_ts": 1638909999, "name": "BurnsAndy" }, "1031380": { "id": "1031380", "name": "deeplusplus", "last_star_ts": 1638922303, "local_score": 145, "global_score": 0, "stars": 12, "completion_day_level": { "6": { "2": { "get_star_ts": 1638917087 }, "1": { "get_star_ts": 1638917072 } }, "5": { "1": { "get_star_ts": 1638921543 }, "2": { "get_star_ts": 1638921698 } }, "7": { "1": { "get_star_ts": 1638922303 } }, "3": { "1": { "get_star_ts": 1638575430 } }, "2": { "1": { "get_star_ts": 1638572713 }, "2": { "get_star_ts": 1638573110 } }, "1": { "2": { "get_star_ts": 1638572067 }, "1": { "get_star_ts": 1638535886 } }, "4": { "2": { "get_star_ts": 1638652170 }, "1": { "get_star_ts": 1638651934 } } } }, "1221136": { "stars": 10, "global_score": 0, "completion_day_level": { "6": { "2": { "get_star_ts": 1638938370 }, "1": { "get_star_ts": 1638938339 } }, "7": { "1": { "get_star_ts": 1638929146 }, "2": { "get_star_ts": 1638930923 } }, "3": { "1": { "get_star_ts": 1638589885 }, "2": { "get_star_ts": 1638647947 } }, "2": { "2": { "get_star_ts": 1638499454 }, "1": { "get_star_ts": 1638498901 } }, "1": { "1": { "get_star_ts": 1638410302 }, "2": { "get_star_ts": 1638411032 } } }, "id": "1221136", "name": "George Lund", "last_star_ts": 1638938370, "local_score": 125 }, "1108620": { "global_score": 0, "stars": 0, "completion_day_level": {}, "local_score": 0, "id": "1108620", "last_star_ts": "0", "name": "Chris Hutchins" }, "1689898": { "completion_day_level": { "4": { "2": { "get_star_ts": 1638607920 }, "1": { "get_star_ts": 1638606808 } }, "3": { "2": { "get_star_ts": 1638513637 }, "1": { "get_star_ts": 1638510276 } }, "2": { "1": { "get_star_ts": 1638425832 }, "2": { "get_star_ts": 1638426677 } }, "7": { "1": { "get_star_ts": 1638857100 }, "2": { "get_star_ts": 1638858612 } }, "6": { "2": { "get_star_ts": 1638770370 }, "1": { "get_star_ts": 1638769139 } }, "1": { "2": { "get_star_ts": 1638416970 }, "1": { "get_star_ts": 1638415710 } }, "5": { "1": { "get_star_ts": 1638687431 }, "2": { "get_star_ts": 1638689309 } }, "8": { "1": { "get_star_ts": 1638943747 }, "2": { "get_star_ts": 1638952813 } } }, "stars": 16, "global_score": 0, "last_star_ts": 1638952813, "name": "Peter McLarnan", "id": "1689898", "local_score": 283 }, "532224": { "local_score": 176, "name": "UncleTed", "last_star_ts": 1638967737, "id": "532224", "completion_day_level": { "7": { "1": { "get_star_ts": 1638883097 }, "2": { "get_star_ts": 1638929101 } }, "6": { "2": { "get_star_ts": 1638917120 }, "1": { "get_star_ts": 1638851847 } }, "4": { "1": { "get_star_ts": 1638675196 } }, "2": { "2": { "get_star_ts": 1638500282 }, "1": { "get_star_ts": 1638500045 } }, "3": { "2": { "get_star_ts": 1638577063 }, "1": { "get_star_ts": 1638572541 } }, "5": { "1": { "get_star_ts": 1638841738 } }, "8": { "1": { "get_star_ts": 1638967737 } }, "1": { "2": { "get_star_ts": 1638507128 }, "1": { "get_star_ts": 1638450048 } } }, "stars": 13, "global_score": 0 }, "1647175": { "global_score": 0, "stars": 4, "completion_day_level": { "1": { "2": { "get_star_ts": 1638377963 }, "1": { "get_star_ts": 1638377636 } }, "2": { "1": { "get_star_ts": 1638684019 }, "2": { "get_star_ts": 1638842526 } } }, "id": "1647175", "last_star_ts": 1638842526, "name": "Matthew Scholand", "local_score": 48 }, "1666139": { "name": null, "last_star_ts": "0", "id": "1666139", "local_score": 0, "completion_day_level": {}, "stars": 0, "global_score": 0 }, "1624251": { "completion_day_level": { "2": { "2": { "get_star_ts": 1638485400 }, "1": { "get_star_ts": 1638485186 } }, "3": { "1": { "get_star_ts": 1638509999 } }, "1": { "2": { "get_star_ts": 1638484539 }, "1": { "get_star_ts": 1638467656 } } }, "global_score": 0, "stars": 5, "name": "tone-segura", "last_star_ts": 1638509999, "id": "1624251", "local_score": 65 }, "1076332": { "completion_day_level": { "3": { "1": { "get_star_ts": 1638746254 } }, "2": { "1": { "get_star_ts": 1638459521 } }, "1": { "1": { "get_star_ts": 1638379746 }, "2": { "get_star_ts": 1638380011 } }, "4": { "1": { "get_star_ts": 1638754015 }, "2": { "get_star_ts": 1638754849 } }, "5": { "1": { "get_star_ts": 1638841804 } } }, "stars": 7, "global_score": 0, "name": "Kealy Williams", "last_star_ts": 1638841804, "id": "1076332", "local_score": 98 }, "1624263": { "global_score": 0, "stars": 12, "completion_day_level": { "6": { "2": { "get_star_ts": 1638931149 }, "1": { "get_star_ts": 1638824102 } }, "7": { "1": { "get_star_ts": 1638933816 } }, "5": { "1": { "get_star_ts": 1638769705 } }, "3": { "1": { "get_star_ts": 1638540594 }, "2": { "get_star_ts": 1638589861 } }, "2": { "1": { "get_star_ts": 1638457397 }, "2": { "get_star_ts": 1638458153 } }, "4": { "1": { "get_star_ts": 1638600184 }, "2": { "get_star_ts": 1638601095 } }, "1": { "2": { "get_star_ts": 1638380859 }, "1": { "get_star_ts": 1638379104 } } }, "local_score": 192, "id": "1624263", "last_star_ts": 1638933816, "name": "wwestfall91" }, "1105834": { "local_score": 248, "name": "Sarah Ball", "last_star_ts": 1638964079, "id": "1105834", "completion_day_level": { "5": { "1": { "get_star_ts": 1638705948 }, "2": { "get_star_ts": 1638708930 } }, "8": { "1": { "get_star_ts": 1638964079 } }, "1": { "2": { "get_star_ts": 1638361995 }, "1": { "get_star_ts": 1638361174 } }, "7": { "1": { "get_star_ts": 1638877430 }, "2": { "get_star_ts": 1638879129 } }, "6": { "2": { "get_star_ts": 1638792889 }, "1": { "get_star_ts": 1638791299 } }, "4": { "1": { "get_star_ts": 1638632343 }, "2": { "get_star_ts": 1638633235 } }, "3": { "1": { "get_star_ts": 1638532084 }, "2": { "get_star_ts": 1638533821 } }, "2": { "1": { "get_star_ts": 1638530779 }, "2": { "get_star_ts": 1638531040 } } }, "stars": 15, "global_score": 0 }, "1866201": { "id": "1866201", "last_star_ts": 1638909804, "name": "Guillermo Bautista", "local_score": 5, "stars": 1, "global_score": 0, "completion_day_level": { "1": { "1": { "get_star_ts": 1638909804 } } } }, "1632578": { "completion_day_level": { "2": { "1": { "get_star_ts": 1638486163 }, "2": { "get_star_ts": 1638486997 } }, "1": { "2": { "get_star_ts": 1638410800 }, "1": { "get_star_ts": 1638408568 } } }, "stars": 4, "global_score": 0, "name": "JD", "last_star_ts": 1638486997, "id": "1632578", "local_score": 53 }, "1109424": { "local_score": 0, "name": "Lisa Ho", "last_star_ts": "0", "id": "1109424", "completion_day_level": {}, "global_score": 0, "stars": 0 } }, "owner_id": "1031380", "event": "2021" }

function parseMember() {
    //objects I THINK I might need to go for - ultimately scores and position will need to be calculated as I go based on starDates to animate...
    // membersArray = [
    //         {
    //             id: 1234,
    //             name: 'Sarah"',
    //         }
    //     ]
    // starDates = [
    //     {
    //         timestamp: new Date(),
    //         memberId: '1234' //so I can find the right element
    //         star: [day, part]
    //     }
    // ]

    let membersArray = [];
    let starDates = [];
    let tempMember;
    let tempStars;
    for (entry in scoresJson.members) {
        tempMember = scoresJson.members[entry];
        membersArray.push({
            id: tempMember.id,
            name: tempMember.name
        });

        tempStars = scoresJson.members[entry].completion_day_level
        for (star in tempStars) {
            for (part in tempStars[star]) {
                starDates.push({
                    timestamp: new Date(tempStars[star][part].get_star_ts * 1000), //used https://www.reddit.com/r/adventofcode/comments/a4ma4o/private_leaderboard_star_times_display to figure out how the date/time should be parsed
                    memberId: tempMember.id,
                    star: [parseInt(star), parseInt(part)]
                });
            }
        }
    }

    return [membersArray, starDates];
}

let parsed = parseMember();
let members = parsed[0];
let stardates = parsed[1].sort((first, second) => (first.timestamp < second.timestamp ? 1 : -1));

console.log(stardates);

let countDownTime = new Date('December 1, 2021 01:00:00');
let countDownStop = Date.now();

let dateChange = false;
let runOnce = true;

let countdown = setInterval(function () {
    if (runOnce) { //hack - I'll deal with it later...
        runOnce = false;
        let newElement = createMemberRows(members)
        let memberRows = document.getElementById("member-rows");
        memberRows.parentNode.replaceChild(newElement, memberRows);
    }

    if (countDownTime < countDownStop) {
        let newDate = dateAdd(countDownTime, 'minute', 5);
        dateChange = newDate.getDate() != countDownTime.getDate();
        countDownTime = newDate
        document.getElementById("countdown").innerHTML = customDateFormat(countDownTime);

        if (dateChange) {
            dateChange = false;
            let dateToUpdate = countDownTime.getDate();

            //Update links of numbers
            let linkedSingleDigitATag = createDayATag(dateToUpdate)
            let parentRowElement = document.getElementsByClassName("privboard-days");
            let elementToUpdate = parentRowElement[0].children[dateToUpdate - 1]; //index off by one
            elementToUpdate.parentNode.replaceChild(linkedSingleDigitATag, elementToUpdate);

            //Update stars for day to "unlocked"
            let memberRows = document.getElementsByClassName("mem-row");
            for (let i = 0; i < memberRows.length; i++) {
                let innerSpans = memberRows[i].children;
                //index 0 is position
                //index 1 is score
                //index 2-27 are stars
                innerSpans[dateToUpdate + 1].classList.remove('privboard-star-locked');
                innerSpans[dateToUpdate + 1].classList.add('privboard-star-unlocked');
            }

        }

        //while last item in stardate is less than current time
        while (stardates.length > 0 &&
            stardates[stardates.length - 1].timestamp < countDownTime) {
            let singleStarDate = stardates[stardates.length - 1];
            let memberRow = document.getElementById(singleStarDate.memberId);

            let innerSpans = memberRow.children;
            //index 0 is position
            //index 1 is score
            //index 2-27 are stars

            //string vs int can be...
            let dayOfStar = singleStarDate.star[0];
            let part1Or2 = singleStarDate.star[1];
            let starSpan = innerSpans[dayOfStar + 1]; //If day 1 star accomplished, want span 3
            if (part1Or2 == "1") {
                starSpan.classList.remove('privboard-star-unlocked');
                starSpan.classList.add('privboard-star-firstonly');
            } else {
                starSpan.classList.remove('privboard-star-firstonly');
                starSpan.classList.add('privboard-star-both');
            }

            stardates.pop();
        }
    }
}, 1);

function customDateFormat(date) {
    return date.getFullYear() + "." + (date.getMonth() + 1).toString().padStart(2, '0') + "." + date.getDate().toString().padStart(2, '0') + " " + date.getHours().toString().padStart(2, '0') + ":" + (date.getMinutes().toString().padStart(2, '0'));
}//                                                      ^because of stupid 0 indexed months

function createDayATag(dayNumber) {
    let linkedSingleDigitATag = document.createElement("a");
    linkedSingleDigitATag.href = "https://adventofcode.com/2021/day/" + dayNumber;
    if (dayNumber < 10) {
        linkedSingleDigitATag.innerText = dayNumber;
    } else {
        let dayDigits = dayNumber.toString().split('');
        const lineBreak = document.createElement('br');
        linkedSingleDigitATag.innerHTML = dayDigits[0] + '<br>' + dayDigits[1];
    }
    return linkedSingleDigitATag
}

/**
 * Adds time to a date. Modelled after MySQL DATE_ADD function.
 * Example: dateAdd(new Date(), 'minute', 30)  //returns 30 minutes from now.
 * https://stackoverflow.com/a/1214753/18511
 * 
 * @param date  Date to start with
 * @param interval  One of: year, quarter, month, week, day, hour, minute, second
 * @param units  Number of units of the given interval to add.
 */
function dateAdd(date, interval, units) {
    if (!(date instanceof Date))
        return undefined;
    var ret = new Date(date); //don't change original date
    var checkRollover = function () { if (ret.getDate() != date.getDate()) ret.setDate(0); };
    switch (String(interval).toLowerCase()) {
        case 'year': ret.setFullYear(ret.getFullYear() + units); checkRollover(); break;
        case 'quarter': ret.setMonth(ret.getMonth() + 3 * units); checkRollover(); break;
        case 'month': ret.setMonth(ret.getMonth() + units); checkRollover(); break;
        case 'week': ret.setDate(ret.getDate() + 7 * units); break;
        case 'day': ret.setDate(ret.getDate() + units); break;
        case 'hour': ret.setTime(ret.getTime() + units * 3600000); break;
        case 'minute': ret.setTime(ret.getTime() + units * 60000); break;
        case 'second': ret.setTime(ret.getTime() + units * 1000); break;
        default: ret = undefined; break;
    }
    return ret;
}

function createMemberRows(members) {
    let containerSpan = document.createElement('span');
    // example element
    // <div id='1105834' class="privboard-row mem-row"><span class="privboard-position"> 1)</span><span class="score"> 000 </span><span class="privboard-star-unlocked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span>  <span class="privboard-name">Sarah Ball</span></div>

    for (let i = 0; i < members.length; i++) {
        let outerDiv = document.createElement('div');
        outerDiv.id = members[i].id;
        outerDiv.classList.add("privboard-createMemberRows", "mem-row");
        outerDiv.innerHTML = '<span class="privboard-position"> #)</span> 000 <span class="privboard-star-locked">*</span><span class="privboard-star-unlocked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span>  <span class="privboard-name">' + members[i].name + '</span>';
        containerSpan.appendChild(outerDiv);
    }
    return containerSpan;
}
