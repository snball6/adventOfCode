const scoresJson = {"owner_id":"1031380","event":"2021","members":{"1108620":{"global_score":0,"local_score":0,"id":"1108620","last_star_ts":"0","completion_day_level":{},"name":"Chris Hutchins","stars":0},"1536781":{"local_score":73,"global_score":0,"stars":4,"completion_day_level":{"1":{"2":{"get_star_ts":1638378029},"1":{"get_star_ts":1638372149}},"2":{"1":{"get_star_ts":1638459485},"2":{"get_star_ts":1638462660}}},"name":"MitchZo","last_star_ts":1638462660,"id":"1536781"},"1221136":{"local_score":206,"global_score":0,"last_star_ts":1639119768,"id":"1221136","stars":14,"name":"George Lund","completion_day_level":{"2":{"1":{"get_star_ts":1638498901},"2":{"get_star_ts":1638499454}},"7":{"2":{"get_star_ts":1638930923},"1":{"get_star_ts":1638929146}},"3":{"1":{"get_star_ts":1638589885},"2":{"get_star_ts":1638647947}},"6":{"2":{"get_star_ts":1638938370},"1":{"get_star_ts":1638938339}},"8":{"2":{"get_star_ts":1639112861},"1":{"get_star_ts":1639018522}},"1":{"1":{"get_star_ts":1638410302},"2":{"get_star_ts":1638411032}},"10":{"1":{"get_star_ts":1639118314},"2":{"get_star_ts":1639119768}}}},"1647175":{"global_score":0,"local_score":62,"id":"1647175","last_star_ts":1639014021,"name":"Matthew Scholand","completion_day_level":{"3":{"1":{"get_star_ts":1639014021}},"1":{"2":{"get_star_ts":1638377963},"1":{"get_star_ts":1638377636}},"2":{"1":{"get_star_ts":1638684019},"2":{"get_star_ts":1638842526}}},"stars":5},"1105834":{"local_score":462,"global_score":0,"stars":26,"completion_day_level":{"11":{"2":{"get_star_ts":1639238049},"1":{"get_star_ts":1639237143}},"4":{"2":{"get_star_ts":1638633235},"1":{"get_star_ts":1638632343}},"6":{"2":{"get_star_ts":1638792889},"1":{"get_star_ts":1638791299}},"13":{"1":{"get_star_ts":1639396656},"2":{"get_star_ts":1639439369}},"8":{"1":{"get_star_ts":1638964079},"2":{"get_star_ts":1639099463}},"10":{"2":{"get_star_ts":1639141323},"1":{"get_star_ts":1639139741}},"7":{"2":{"get_star_ts":1638879129},"1":{"get_star_ts":1638877430}},"12":{"2":{"get_star_ts":1639347535},"1":{"get_star_ts":1639346569}},"2":{"2":{"get_star_ts":1638531040},"1":{"get_star_ts":1638530779}},"9":{"2":{"get_star_ts":1639104569},"1":{"get_star_ts":1639052333}},"1":{"1":{"get_star_ts":1638361174},"2":{"get_star_ts":1638361995}},"5":{"1":{"get_star_ts":1638705948},"2":{"get_star_ts":1638708930}},"3":{"1":{"get_star_ts":1638532084},"2":{"get_star_ts":1638533821}}},"name":"Sarah Ball","last_star_ts":1639439369,"id":"1105834"},"1031380":{"local_score":157,"global_score":0,"stars":12,"name":"deeplusplus","completion_day_level":{"3":{"1":{"get_star_ts":1638575430}},"5":{"2":{"get_star_ts":1638921698},"1":{"get_star_ts":1638921543}},"7":{"1":{"get_star_ts":1638922303}},"1":{"2":{"get_star_ts":1638572067},"1":{"get_star_ts":1638535886}},"6":{"1":{"get_star_ts":1638917072},"2":{"get_star_ts":1638917087}},"4":{"1":{"get_star_ts":1638651934},"2":{"get_star_ts":1638652170}},"2":{"2":{"get_star_ts":1638573110},"1":{"get_star_ts":1638572713}}},"last_star_ts":1638922303,"id":"1031380"},"1915282":{"stars":3,"name":"Lisa Ho","completion_day_level":{"1":{"1":{"get_star_ts":1639089646},"2":{"get_star_ts":1639089926}},"2":{"1":{"get_star_ts":1639090597}}},"last_star_ts":1639090597,"id":"1915282","local_score":17,"global_score":0},"1236060":{"global_score":0,"local_score":0,"id":"1236060","last_star_ts":"0","completion_day_level":{},"name":"Giovanni Sturla","stars":0},"1689898":{"id":"1689898","last_star_ts":1639379326,"name":"Peter McLarnan","completion_day_level":{"9":{"2":{"get_star_ts":1639031733},"1":{"get_star_ts":1639026763}},"1":{"2":{"get_star_ts":1638416970},"1":{"get_star_ts":1638415710}},"5":{"1":{"get_star_ts":1638687431},"2":{"get_star_ts":1638689309}},"3":{"2":{"get_star_ts":1638513637},"1":{"get_star_ts":1638510276}},"2":{"1":{"get_star_ts":1638425832},"2":{"get_star_ts":1638426677}},"13":{"1":{"get_star_ts":1639378019},"2":{"get_star_ts":1639379326}},"8":{"1":{"get_star_ts":1638943747},"2":{"get_star_ts":1638952813}},"6":{"2":{"get_star_ts":1638770370},"1":{"get_star_ts":1638769139}},"10":{"2":{"get_star_ts":1639125720},"1":{"get_star_ts":1639124195}},"7":{"2":{"get_star_ts":1638858612},"1":{"get_star_ts":1638857100}},"12":{"2":{"get_star_ts":1639310667},"1":{"get_star_ts":1639301357}},"11":{"1":{"get_star_ts":1639200894},"2":{"get_star_ts":1639201073}},"4":{"1":{"get_star_ts":1638606808},"2":{"get_star_ts":1638607920}}},"stars":26,"global_score":0,"local_score":492},"1632578":{"global_score":0,"local_score":57,"id":"1632578","last_star_ts":1638486997,"name":"JD","completion_day_level":{"1":{"2":{"get_star_ts":1638410800},"1":{"get_star_ts":1638408568}},"2":{"1":{"get_star_ts":1638486163},"2":{"get_star_ts":1638486997}}},"stars":4},"1624263":{"name":"wwestfall91","completion_day_level":{"2":{"1":{"get_star_ts":1638457397},"2":{"get_star_ts":1638458153}},"5":{"1":{"get_star_ts":1638769705}},"3":{"2":{"get_star_ts":1638589861},"1":{"get_star_ts":1638540594}},"1":{"1":{"get_star_ts":1638379104},"2":{"get_star_ts":1638380859}},"4":{"2":{"get_star_ts":1638601095},"1":{"get_star_ts":1638600184}},"7":{"1":{"get_star_ts":1638933816}},"6":{"2":{"get_star_ts":1638931149},"1":{"get_star_ts":1638824102}},"10":{"1":{"get_star_ts":1639157262}}},"stars":13,"id":"1624263","last_star_ts":1639157262,"global_score":0,"local_score":219},"1866201":{"completion_day_level":{"1":{"1":{"get_star_ts":1638909804}}},"name":"Guillermo Bautista","stars":1,"id":"1866201","last_star_ts":1638909804,"global_score":0,"local_score":6},"1108809":{"local_score":31,"global_score":0,"stars":4,"completion_day_level":{"1":{"2":{"get_star_ts":1638584322},"1":{"get_star_ts":1638583910}},"2":{"1":{"get_star_ts":1638585499},"2":{"get_star_ts":1638586544}}},"name":"Scott Krumrei","last_star_ts":1638586544,"id":"1108809"},"1109424":{"global_score":0,"local_score":0,"name":"Lisa Ho","completion_day_level":{},"stars":0,"id":"1109424","last_star_ts":"0"},"1727519":{"global_score":0,"local_score":456,"id":"1727519","last_star_ts":1639404844,"completion_day_level":{"2":{"1":{"get_star_ts":1638496234},"2":{"get_star_ts":1638497354}},"9":{"2":{"get_star_ts":1639031472},"1":{"get_star_ts":1639028208}},"1":{"2":{"get_star_ts":1638454522},"1":{"get_star_ts":1638454097}},"5":{"1":{"get_star_ts":1638761056},"2":{"get_star_ts":1638762771}},"3":{"2":{"get_star_ts":1638513824},"1":{"get_star_ts":1638512313}},"11":{"2":{"get_star_ts":1639200707},"1":{"get_star_ts":1639200503}},"4":{"1":{"get_star_ts":1638681139},"2":{"get_star_ts":1638681356}},"8":{"1":{"get_star_ts":1638976311},"2":{"get_star_ts":1638979007}},"6":{"2":{"get_star_ts":1638811208},"1":{"get_star_ts":1638811172}},"13":{"2":{"get_star_ts":1639404844},"1":{"get_star_ts":1639404339}},"10":{"2":{"get_star_ts":1639115229},"1":{"get_star_ts":1639114004}},"7":{"2":{"get_star_ts":1638853947},"1":{"get_star_ts":1638853790}},"12":{"2":{"get_star_ts":1639368229},"1":{"get_star_ts":1639366579}}},"name":"Murtuza Boxwala","stars":26},"532224":{"id":"532224","last_star_ts":1639179778,"name":"UncleTed","completion_day_level":{"5":{"1":{"get_star_ts":1638841738}},"3":{"2":{"get_star_ts":1638577063},"1":{"get_star_ts":1638572541}},"1":{"1":{"get_star_ts":1638450048},"2":{"get_star_ts":1638507128}},"2":{"2":{"get_star_ts":1638500282},"1":{"get_star_ts":1638500045}},"7":{"1":{"get_star_ts":1638883097},"2":{"get_star_ts":1638929101}},"8":{"1":{"get_star_ts":1638967737}},"6":{"2":{"get_star_ts":1638917120},"1":{"get_star_ts":1638851847}},"10":{"2":{"get_star_ts":1639179778},"1":{"get_star_ts":1639142199}},"4":{"1":{"get_star_ts":1638675196}}},"stars":15,"global_score":0,"local_score":221},"1624251":{"local_score":95,"global_score":0,"last_star_ts":1639020974,"id":"1624251","stars":7,"completion_day_level":{"3":{"2":{"get_star_ts":1639013503},"1":{"get_star_ts":1638509999}},"1":{"2":{"get_star_ts":1638484539},"1":{"get_star_ts":1638467656}},"4":{"1":{"get_star_ts":1639020974}},"2":{"1":{"get_star_ts":1638485186},"2":{"get_star_ts":1638485400}}},"name":"tone-segura"},"1032152":{"local_score":183,"global_score":0,"last_star_ts":1638909999,"id":"1032152","stars":12,"name":"BurnsAndy","completion_day_level":{"1":{"1":{"get_star_ts":1638393039},"2":{"get_star_ts":1638393565}},"6":{"1":{"get_star_ts":1638909961},"2":{"get_star_ts":1638909999}},"3":{"2":{"get_star_ts":1638734524},"1":{"get_star_ts":1638539275}},"5":{"1":{"get_star_ts":1638891688},"2":{"get_star_ts":1638903065}},"2":{"1":{"get_star_ts":1638464807},"2":{"get_star_ts":1638466033}},"4":{"2":{"get_star_ts":1638822590},"1":{"get_star_ts":1638821862}}}},"1076332":{"stars":9,"completion_day_level":{"4":{"1":{"get_star_ts":1638754015},"2":{"get_star_ts":1638754849}},"2":{"1":{"get_star_ts":1638459521}},"3":{"1":{"get_star_ts":1638746254}},"7":{"1":{"get_star_ts":1639103806}},"5":{"1":{"get_star_ts":1638841804}},"1":{"2":{"get_star_ts":1638380011},"1":{"get_star_ts":1638379746}},"6":{"1":{"get_star_ts":1639017778}}},"name":"Kealy Williams","last_star_ts":1639103806,"id":"1076332","local_score":130,"global_score":0},"1666139":{"completion_day_level":{},"name":null,"stars":0,"id":"1666139","last_star_ts":"0","global_score":0,"local_score":0}}}
function parseJson() {
    //objects I THINK I might need to go for - ultimately scores and position will need to be calculated as I go based on starDates to animate...
    // membersArray = [
    //         {
    //             id: 1234,
    //             name: 'Sarah"',
    //         }
    //     ]
    // starDates = [
    //     {
    //         timestamp: new Date(),
    //         memberId: '1234' //so I can find the right element
    //         star: [day, part]
    //     }
    // ]

    let membersArray = [];
    let starDates = [];
    let tempMember;
    let tempStars;
    for (entry in scoresJson.members) {
        tempMember = scoresJson.members[entry];
        membersArray.push({
            id: tempMember.id,
            name: tempMember.name
        });

        tempStars = scoresJson.members[entry].completion_day_level
        for (star in tempStars) {
            for (part in tempStars[star]) {
                starDates.push({
                    timestamp: new Date(tempStars[star][part].get_star_ts * 1000), //used https://www.reddit.com/r/adventofcode/comments/a4ma4o/private_leaderboard_star_times_display to figure out how the date/time should be parsed
                    memberId: tempMember.id,
                    star: [parseInt(star), parseInt(part)]
                });
            }
        }
    }

    return [membersArray, starDates];
}

let parsed = parseJson();
let members = parsed[0];
let stardates = parsed[1].sort((first, second) => (first.timestamp < second.timestamp ? 1 : -1));
let starPointsAvailable = generateInitialStarValues(members.length);
let memberToScoreMapScores = initializeMemberScores(members);


let countDownTime = new Date('December 1, 2021 01:00:00');
let countDownStop = Date.now();

let dateChange = false;
let runOnce = true;

let countdown = setInterval(function () {
    if (runOnce) { //hack - I'll deal with it later...
        runOnce = false;
        let newElement = createMemberRows(members)
        let memberRows = document.getElementById("member-rows");
        memberRows.parentNode.replaceChild(newElement, memberRows);
    }

    if (countDownTime < countDownStop) {
        let newDate = dateAdd(countDownTime, 'minute', 1);
        dateChange = newDate.getDate() != countDownTime.getDate();
        countDownTime = newDate
        document.getElementById("countdown").innerHTML = customDateFormat(countDownTime);

        if (dateChange) {
            dateChange = false;
            let dateToUpdate = countDownTime.getDate();

            //Update links of numbers
            let linkedSingleDigitATag = createDayATag(dateToUpdate)
            let parentRowElement = document.getElementsByClassName("privboard-days");
            let elementToUpdate = parentRowElement[0].children[dateToUpdate - 1];
            elementToUpdate.parentNode.replaceChild(linkedSingleDigitATag, elementToUpdate);

            //Update stars for day to "unlocked"
            let memberRows = document.getElementsByClassName("mem-row");
            for (let i = 0; i < memberRows.length; i++) {
                let innerSpans = memberRows[i].children;
                //index 0 is position
                //index 1 is score
                //index 2-27 are stars
                innerSpans[dateToUpdate + 2].classList.remove('privboard-star-locked');
                innerSpans[dateToUpdate + 2].classList.add('privboard-star-unlocked');
            }
        }

        //while last item in stardate is less than current time
        while (stardates.length > 0 &&
            stardates[stardates.length - 1].timestamp < countDownTime) {
            let singleStarDate = stardates[stardates.length - 1];
            let memberRow = document.getElementById(singleStarDate.memberId);

            //----------------------------update star----------------------------
            let innerSpans = memberRow.children;
            //index 0 is position
            //index 1 is score
            //index 2-27 are stars

            let dayOfStar = singleStarDate.star[0];
            let part1Or2 = singleStarDate.star[1];
            let starSpan = innerSpans[dayOfStar + 2];
            if (part1Or2 == "1") {
                starSpan.classList.remove('privboard-star-unlocked');
                starSpan.classList.add('privboard-star-firstonly');
            } else {
                starSpan.classList.remove('privboard-star-firstonly');
                starSpan.classList.add('privboard-star-both');
            }

            //----------------------------update score----------------------------
            let priorScore = memberToScoreMapScores[singleStarDate.memberId];
            let pointsForNewStar = starPointsAvailable[dayOfStar + '.' + part1Or2];
            let newScore = priorScore + pointsForNewStar;
            memberToScoreMapScores[singleStarDate.memberId] = newScore;

            innerSpans[1].innerHTML = paddedScores(newScore);
            starPointsAvailable[dayOfStar + '.' + part1Or2] = pointsForNewStar - 1; //deincrement for next winner
            stardates.pop();

            //----------------------------sort rows----------------------------
            let positions = getPositions(memberToScoreMapScores)
            buildOrderedMemberList(positions);
        }
    }
}, 1);


function paddedScores(value) {
    switch (value.toString().length) {
        case 3:
            return "&nbsp" + value ;
        case 2:
            return "&nbsp&nbsp" + value ;
        case 1:
            return "&nbsp&nbsp&nbsp" + value ;
        default:
            return "Bad score value";
    }
}

function customDateFormat(date) {
    return date.getFullYear() + "." + (date.getMonth() + 1).toString().padStart(2, '0') + "." + date.getDate().toString().padStart(2, '0') + " " + date.getHours().toString().padStart(2, '0') + ":" + (date.getMinutes().toString().padStart(2, '0'));
}//                                                      ^because of stupid 0 indexed months

function createDayATag(dayNumber) {
    let linkedSingleDigitATag = document.createElement("a");
    linkedSingleDigitATag.href = "https://adventofcode.com/2021/day/" + dayNumber;
    if (dayNumber < 10) {
        linkedSingleDigitATag.innerText = dayNumber;
    } else {
        let dayDigits = dayNumber.toString().split('');
        const lineBreak = document.createElement('br');
        linkedSingleDigitATag.innerHTML = dayDigits[0] + '<br>' + dayDigits[1];
    }
    return linkedSingleDigitATag
}

/**
 * Adds time to a date. Modelled after MySQL DATE_ADD function.
 * Example: dateAdd(new Date(), 'minute', 30)  //returns 30 minutes from now.
 * https://stackoverflow.com/a/1214753/18511
 * 
 * @param date  Date to start with
 * @param interval  One of: year, quarter, month, week, day, hour, minute, second
 * @param units  Number of units of the given interval to add.
 */
function dateAdd(date, interval, units) {
    if (!(date instanceof Date))
        return undefined;
    var ret = new Date(date); //don't change original date
    var checkRollover = function () { if (ret.getDate() != date.getDate()) ret.setDate(0); };
    switch (String(interval).toLowerCase()) {
        case 'year': ret.setFullYear(ret.getFullYear() + units); checkRollover(); break;
        case 'quarter': ret.setMonth(ret.getMonth() + 3 * units); checkRollover(); break;
        case 'month': ret.setMonth(ret.getMonth() + units); checkRollover(); break;
        case 'week': ret.setDate(ret.getDate() + 7 * units); break;
        case 'day': ret.setDate(ret.getDate() + units); break;
        case 'hour': ret.setTime(ret.getTime() + units * 3600000); break;
        case 'minute': ret.setTime(ret.getTime() + units * 60000); break;
        case 'second': ret.setTime(ret.getTime() + units * 1000); break;
        default: ret = undefined; break;
    }
    return ret;
}

function createMemberRows(members) {
    let containerSpan = document.createElement('span');
    // example element
    // <div id='1105834' class="privboard-row mem-row"><span class="privboard-position"> 1)</span><span class="score"> 000 </span><span class="privboard-star-unlocked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span>  <span class="privboard-name">Sarah Ball</span></div>

    for (let i = 0; i < members.length; i++) {
        //Hailey case
        if(members[i].id == '1666139'){
            members[i].name = "Hailey Quinn";
        }
        let outerDiv = document.createElement('div');
        outerDiv.id = members[i].id;
        outerDiv.classList.add("privboard-createMemberRows", "mem-row");
        outerDiv.innerHTML = '<span id="'+members[i].id+'-position" class="privboard-position">'+padAndFormatPosition(i+1)+'</span><span>'+paddedScores(0)+'</span>'
        +'<span class="privboard-star-locked">*</span><span class="privboard-star-unlocked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span>  <span class="privboard-name">' + members[i].name + '</span>';
        containerSpan.appendChild(outerDiv);
    }
    return containerSpan;
}

function buildOrderedMemberList(positions){
    for(let memIndex =0; memIndex<positions.length; memIndex++){
        let member = positions[memIndex];
        let memberRow = document.getElementById(member.id);
        let scoreSpan = document.getElementById(member.id+"-position");
        scoreSpan.innerHTML = padAndFormatPosition(memIndex+1);//zero index

        memberRow.parentNode.appendChild(memberRow);
    }
}

function padAndFormatPosition(value){
    switch (value.toString().length) {
        case 1:
            return "&nbsp" + value + ")";
        case 2:
            return value + ")";
        default:
            return "Bad position value";
    }
}

function initializeMemberScores(members) {
    let scores = {};
    for (let i = 0; i < members.length; i++) {
        scores[members[i].id] = 0;
    }
    return scores;
}

function getPositions(memberToScoreMapScores){
    let order = [];

    for(key in memberToScoreMapScores){
        order.push({
            id: key,
            score: memberToScoreMapScores[key]
        });
    }

    order.sort((a,b) => b.score-a.score);

    return order;
}

function generateInitialStarValues(memberNumber) {
    return {
        '1.1': memberNumber,
        '2.1': memberNumber,
        '3.1': memberNumber,
        '4.1': memberNumber,
        '5.1': memberNumber,
        '6.1': memberNumber,
        '7.1': memberNumber,
        '8.1': memberNumber,
        '9.1': memberNumber,
        '10.1': memberNumber,
        '11.1': memberNumber,
        '12.1': memberNumber,
        '13.1': memberNumber,
        '14.1': memberNumber,
        '15.1': memberNumber,
        '16.1': memberNumber,
        '17.1': memberNumber,
        '18.1': memberNumber,
        '19.1': memberNumber,
        '20.1': memberNumber,
        '21.1': memberNumber,
        '22.1': memberNumber,
        '23.1': memberNumber,
        '24.1': memberNumber,
        '25.1': memberNumber,
        '1.2': memberNumber,
        '2.2': memberNumber,
        '3.2': memberNumber,
        '4.2': memberNumber,
        '5.2': memberNumber,
        '6.2': memberNumber,
        '7.2': memberNumber,
        '8.2': memberNumber,
        '9.2': memberNumber,
        '10.2': memberNumber,
        '11.2': memberNumber,
        '12.2': memberNumber,
        '13.2': memberNumber,
        '14.2': memberNumber,
        '15.2': memberNumber,
        '16.2': memberNumber,
        '17.2': memberNumber,
        '18.2': memberNumber,
        '19.2': memberNumber,
        '20.2': memberNumber,
        '21.2': memberNumber,
        '22.2': memberNumber,
        '23.2': memberNumber,
        '24.2': memberNumber,
        '25.2': memberNumber
    }
}
