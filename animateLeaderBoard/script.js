
const scoresJson = {
    "event": "2021",
    "owner_id": "1031380",
    "members": {
        "1236060": {
            "last_star_ts": "0",
            "name": "Giovanni Sturla",
            "completion_day_level": {},
            "id": "1236060",
            "stars": 0,
            "global_score": 0,
            "local_score": 0
        },
        "1105834": {
            "global_score": 0,
            "stars": 14,
            "local_score": 230,
            "completion_day_level": {
                "3": {
                    "2": {
                        "get_star_ts": 1638533821
                    },
                    "1": {
                        "get_star_ts": 1638532084
                    }
                },
                "7": {
                    "1": {
                        "get_star_ts": 1638877430
                    },
                    "2": {
                        "get_star_ts": 1638879129
                    }
                },
                "2": {
                    "1": {
                        "get_star_ts": 1638530779
                    },
                    "2": {
                        "get_star_ts": 1638531040
                    }
                },
                "4": {
                    "1": {
                        "get_star_ts": 1638632343
                    },
                    "2": {
                        "get_star_ts": 1638633235
                    }
                },
                "6": {
                    "1": {
                        "get_star_ts": 1638791299
                    },
                    "2": {
                        "get_star_ts": 1638792889
                    }
                },
                "1": {
                    "2": {
                        "get_star_ts": 1638361995
                    },
                    "1": {
                        "get_star_ts": 1638361174
                    }
                },
                "5": {
                    "2": {
                        "get_star_ts": 1638708930
                    },
                    "1": {
                        "get_star_ts": 1638705948
                    }
                }
            },
            "id": "1105834",
            "last_star_ts": 1638879129,
            "name": "Sarah Ball"
        },
        "1647175": {
            "stars": 4,
            "local_score": 48,
            "global_score": 0,
            "completion_day_level": {
                "2": {
                    "2": {
                        "get_star_ts": 1638842526
                    },
                    "1": {
                        "get_star_ts": 1638684019
                    }
                },
                "1": {
                    "2": {
                        "get_star_ts": 1638377963
                    },
                    "1": {
                        "get_star_ts": 1638377636
                    }
                }
            },
            "id": "1647175",
            "name": "Matthew Scholand",
            "last_star_ts": 1638842526
        },
        "1108620": {
            "completion_day_level": {},
            "id": "1108620",
            "local_score": 0,
            "stars": 0,
            "global_score": 0,
            "name": "Chris Hutchins",
            "last_star_ts": "0"
        },
        "1031380": {
            "last_star_ts": 1638922303,
            "name": "deeplusplus",
            "stars": 12,
            "global_score": 0,
            "local_score": 145,
            "id": "1031380",
            "completion_day_level": {
                "5": {
                    "1": {
                        "get_star_ts": 1638921543
                    },
                    "2": {
                        "get_star_ts": 1638921698
                    }
                },
                "6": {
                    "2": {
                        "get_star_ts": 1638917087
                    },
                    "1": {
                        "get_star_ts": 1638917072
                    }
                },
                "4": {
                    "1": {
                        "get_star_ts": 1638651934
                    },
                    "2": {
                        "get_star_ts": 1638652170
                    }
                },
                "1": {
                    "2": {
                        "get_star_ts": 1638572067
                    },
                    "1": {
                        "get_star_ts": 1638535886
                    }
                },
                "2": {
                    "2": {
                        "get_star_ts": 1638573110
                    },
                    "1": {
                        "get_star_ts": 1638572713
                    }
                },
                "7": {
                    "1": {
                        "get_star_ts": 1638922303
                    }
                },
                "3": {
                    "1": {
                        "get_star_ts": 1638575430
                    }
                }
            }
        },
        "1032152": {
            "id": "1032152",
            "completion_day_level": {
                "3": {
                    "1": {
                        "get_star_ts": 1638539275
                    },
                    "2": {
                        "get_star_ts": 1638734524
                    }
                },
                "2": {
                    "1": {
                        "get_star_ts": 1638464807
                    },
                    "2": {
                        "get_star_ts": 1638466033
                    }
                },
                "6": {
                    "1": {
                        "get_star_ts": 1638909961
                    },
                    "2": {
                        "get_star_ts": 1638909999
                    }
                },
                "4": {
                    "1": {
                        "get_star_ts": 1638821862
                    },
                    "2": {
                        "get_star_ts": 1638822590
                    }
                },
                "1": {
                    "2": {
                        "get_star_ts": 1638393565
                    },
                    "1": {
                        "get_star_ts": 1638393039
                    }
                },
                "5": {
                    "2": {
                        "get_star_ts": 1638903065
                    },
                    "1": {
                        "get_star_ts": 1638891688
                    }
                }
            },
            "stars": 12,
            "local_score": 171,
            "global_score": 0,
            "last_star_ts": 1638909999,
            "name": "BurnsAndy"
        },
        "1221136": {
            "completion_day_level": {
                "2": {
                    "2": {
                        "get_star_ts": 1638499454
                    },
                    "1": {
                        "get_star_ts": 1638498901
                    }
                },
                "1": {
                    "1": {
                        "get_star_ts": 1638410302
                    },
                    "2": {
                        "get_star_ts": 1638411032
                    }
                },
                "3": {
                    "1": {
                        "get_star_ts": 1638589885
                    },
                    "2": {
                        "get_star_ts": 1638647947
                    }
                }
            },
            "id": "1221136",
            "local_score": 72,
            "stars": 6,
            "global_score": 0,
            "name": "George Lund",
            "last_star_ts": 1638647947
        },
        "1666139": {
            "name": null,
            "last_star_ts": "0",
            "id": "1666139",
            "completion_day_level": {},
            "global_score": 0,
            "stars": 0,
            "local_score": 0
        },
        "1109424": {
            "name": "Lisa Ho",
            "last_star_ts": "0",
            "stars": 0,
            "global_score": 0,
            "local_score": 0,
            "id": "1109424",
            "completion_day_level": {}
        },
        "1536781": {
            "last_star_ts": 1638462660,
            "name": "MitchZo",
            "global_score": 0,
            "stars": 4,
            "local_score": 69,
            "completion_day_level": {
                "2": {
                    "2": {
                        "get_star_ts": 1638462660
                    },
                    "1": {
                        "get_star_ts": 1638459485
                    }
                },
                "1": {
                    "1": {
                        "get_star_ts": 1638372149
                    },
                    "2": {
                        "get_star_ts": 1638378029
                    }
                }
            },
            "id": "1536781"
        },
        "1689898": {
            "last_star_ts": 1638858612,
            "name": "Peter McLarnan",
            "completion_day_level": {
                "3": {
                    "2": {
                        "get_star_ts": 1638513637
                    },
                    "1": {
                        "get_star_ts": 1638510276
                    }
                },
                "2": {
                    "1": {
                        "get_star_ts": 1638425832
                    },
                    "2": {
                        "get_star_ts": 1638426677
                    }
                },
                "7": {
                    "1": {
                        "get_star_ts": 1638857100
                    },
                    "2": {
                        "get_star_ts": 1638858612
                    }
                },
                "5": {
                    "2": {
                        "get_star_ts": 1638689309
                    },
                    "1": {
                        "get_star_ts": 1638687431
                    }
                },
                "1": {
                    "2": {
                        "get_star_ts": 1638416970
                    },
                    "1": {
                        "get_star_ts": 1638415710
                    }
                },
                "6": {
                    "2": {
                        "get_star_ts": 1638770370
                    },
                    "1": {
                        "get_star_ts": 1638769139
                    }
                },
                "4": {
                    "1": {
                        "get_star_ts": 1638606808
                    },
                    "2": {
                        "get_star_ts": 1638607920
                    }
                }
            },
            "id": "1689898",
            "stars": 14,
            "global_score": 0,
            "local_score": 245
        },
        "1108809": {
            "global_score": 0,
            "stars": 4,
            "local_score": 27,
            "id": "1108809",
            "completion_day_level": {
                "1": {
                    "2": {
                        "get_star_ts": 1638584322
                    },
                    "1": {
                        "get_star_ts": 1638583910
                    }
                },
                "2": {
                    "1": {
                        "get_star_ts": 1638585499
                    },
                    "2": {
                        "get_star_ts": 1638586544
                    }
                }
            },
            "name": "Scott Krumrei",
            "last_star_ts": 1638586544
        },
        "532224": {
            "last_star_ts": 1638917120,
            "name": "UncleTed",
            "id": "532224",
            "completion_day_level": {
                "3": {
                    "2": {
                        "get_star_ts": 1638577063
                    },
                    "1": {
                        "get_star_ts": 1638572541
                    }
                },
                "7": {
                    "1": {
                        "get_star_ts": 1638883097
                    }
                },
                "2": {
                    "2": {
                        "get_star_ts": 1638500282
                    },
                    "1": {
                        "get_star_ts": 1638500045
                    }
                },
                "1": {
                    "2": {
                        "get_star_ts": 1638507128
                    },
                    "1": {
                        "get_star_ts": 1638450048
                    }
                },
                "4": {
                    "1": {
                        "get_star_ts": 1638675196
                    }
                },
                "6": {
                    "1": {
                        "get_star_ts": 1638851847
                    },
                    "2": {
                        "get_star_ts": 1638917120
                    }
                },
                "5": {
                    "1": {
                        "get_star_ts": 1638841738
                    }
                }
            },
            "global_score": 0,
            "stars": 11,
            "local_score": 143
        },
        "1727519": {
            "global_score": 0,
            "stars": 14,
            "local_score": 214,
            "id": "1727519",
            "completion_day_level": {
                "3": {
                    "2": {
                        "get_star_ts": 1638513824
                    },
                    "1": {
                        "get_star_ts": 1638512313
                    }
                },
                "1": {
                    "2": {
                        "get_star_ts": 1638454522
                    },
                    "1": {
                        "get_star_ts": 1638454097
                    }
                },
                "4": {
                    "2": {
                        "get_star_ts": 1638681356
                    },
                    "1": {
                        "get_star_ts": 1638681139
                    }
                },
                "6": {
                    "1": {
                        "get_star_ts": 1638811172
                    },
                    "2": {
                        "get_star_ts": 1638811208
                    }
                },
                "5": {
                    "2": {
                        "get_star_ts": 1638762771
                    },
                    "1": {
                        "get_star_ts": 1638761056
                    }
                },
                "7": {
                    "2": {
                        "get_star_ts": 1638853947
                    },
                    "1": {
                        "get_star_ts": 1638853790
                    }
                },
                "2": {
                    "2": {
                        "get_star_ts": 1638497354
                    },
                    "1": {
                        "get_star_ts": 1638496234
                    }
                }
            },
            "name": "Murtuza Boxwala",
            "last_star_ts": 1638853947
        },
        "1866201": {
            "name": "Guillermo Bautista",
            "last_star_ts": 1638909804,
            "id": "1866201",
            "completion_day_level": {
                "1": {
                    "1": {
                        "get_star_ts": 1638909804
                    }
                }
            },
            "stars": 1,
            "local_score": 5,
            "global_score": 0
        },
        "1624251": {
            "completion_day_level": {
                "3": {
                    "1": {
                        "get_star_ts": 1638509999
                    }
                },
                "1": {
                    "2": {
                        "get_star_ts": 1638484539
                    },
                    "1": {
                        "get_star_ts": 1638467656
                    }
                },
                "2": {
                    "2": {
                        "get_star_ts": 1638485400
                    },
                    "1": {
                        "get_star_ts": 1638485186
                    }
                }
            },
            "id": "1624251",
            "global_score": 0,
            "stars": 5,
            "local_score": 65,
            "name": "tone-segura",
            "last_star_ts": 1638509999
        },
        "1632578": {
            "name": "JD",
            "last_star_ts": 1638486997,
            "global_score": 0,
            "stars": 4,
            "local_score": 53,
            "completion_day_level": {
                "2": {
                    "1": {
                        "get_star_ts": 1638486163
                    },
                    "2": {
                        "get_star_ts": 1638486997
                    }
                },
                "1": {
                    "2": {
                        "get_star_ts": 1638410800
                    },
                    "1": {
                        "get_star_ts": 1638408568
                    }
                }
            },
            "id": "1632578"
        },
        "1076332": {
            "last_star_ts": 1638841804,
            "name": "Kealy Williams",
            "stars": 7,
            "global_score": 0,
            "local_score": 98,
            "id": "1076332",
            "completion_day_level": {
                "2": {
                    "1": {
                        "get_star_ts": 1638459521
                    }
                },
                "5": {
                    "1": {
                        "get_star_ts": 1638841804
                    }
                },
                "1": {
                    "1": {
                        "get_star_ts": 1638379746
                    },
                    "2": {
                        "get_star_ts": 1638380011
                    }
                },
                "4": {
                    "2": {
                        "get_star_ts": 1638754849
                    },
                    "1": {
                        "get_star_ts": 1638754015
                    }
                },
                "3": {
                    "1": {
                        "get_star_ts": 1638746254
                    }
                }
            }
        },
        "1624263": {
            "name": "wwestfall91",
            "last_star_ts": 1638824102,
            "id": "1624263",
            "completion_day_level": {
                "3": {
                    "2": {
                        "get_star_ts": 1638589861
                    },
                    "1": {
                        "get_star_ts": 1638540594
                    }
                },
                "5": {
                    "1": {
                        "get_star_ts": 1638769705
                    }
                },
                "4": {
                    "1": {
                        "get_star_ts": 1638600184
                    },
                    "2": {
                        "get_star_ts": 1638601095
                    }
                },
                "1": {
                    "1": {
                        "get_star_ts": 1638379104
                    },
                    "2": {
                        "get_star_ts": 1638380859
                    }
                },
                "6": {
                    "1": {
                        "get_star_ts": 1638824102
                    }
                },
                "2": {
                    "1": {
                        "get_star_ts": 1638457397
                    },
                    "2": {
                        "get_star_ts": 1638458153
                    }
                }
            },
            "local_score": 166,
            "stars": 10,
            "global_score": 0
        }
    }
}

// used for help parsing data https://www.reddit.com/r/adventofcode/comments/a4ma4o/private_leaderboard_star_times_display/

// function parse(responseText) { 
//     resp=JSON.parse(responseText); 
//     sortedMembers = Object.values(resp.members).sort((a,b) => b.local_score - a.local_score); 
//     for(i=1; i<sortedMembers.length; i++) {
//         stars = rows[i].querySelectorAll(".privboard-star-both, .privboard-star-firstonly, .privboard-star-unlocked");
//         for(let day in sortedMembers[i-1].completion_day_level) {
//             var compl1 = sortedMembers[i-1].completion_day_level[day][1];
//             var compl2 = sortedMembers[i-1].completion_day_level[day][2];
//             stars[day-1].title = "" 
//                 + (compl1 != null ? (new Date(compl1.get_star_ts*1000)) : "")
//                 + (compl2 != null ? ("\n"+new Date(compl2.get_star_ts*1000)) : "");
//         }
//     }
// }; 
function parseMember() {
    //objects I THINK I might need to go for - ultimately scores and position will need to be calculated as I go based on starDates to animate...
    // membersArray = [
    //         {
    //             id: 1234,
    //             name: 'Sarah"',
    //         }
    //     ]
    // starDates = [
    //     {
    //         timestamp: new Date(),
    //         memberId: '1234' //so I can find the right element
    //         star: [day, part]
    //     }
    // ]

    let membersArray = [];
    let tempMember;
    for (entry in scoresJson.members) {
        tempMember = scoresJson.members[entry];
        membersArray.push({
            id: tempMember.id,
            name: tempMember.name
        });
    }

    return membersArray
}

let members = parseMember();

let countDownTime = new Date('December 1, 2021 01:00:00');
let countDownStop = new Date('December 25, 2021 05:00:00')

let dateChange = false;
let runOnce = true;
let countdown = setInterval(function () {
    if (runOnce) {
        runOnce = false;
        let newElement = createMemberRows(members)
        let memberRows = document.getElementById("member-rows");
        memberRows.parentNode.replaceChild(newElement, memberRows);
    }

    if (countDownTime < countDownStop) {


        let newDate = dateAdd(countDownTime, 'minute', 5);
        dateChange = newDate.getDate() != countDownTime.getDate();
        countDownTime = newDate
        document.getElementById("countdown").innerHTML = customDateFormat(countDownTime);

        if (dateChange) {
            dateChange = false;
            let dateToUpdate = countDownTime.getDate();

            //Update links of numbers
            let linkedSingleDigitATag = createDayATag(dateToUpdate)
            let parentRowElement = document.getElementsByClassName("privboard-days");
            let elementToUpdate = parentRowElement[0].children[dateToUpdate - 1]; //index off by one
            elementToUpdate.parentNode.replaceChild(linkedSingleDigitATag, elementToUpdate);

            //Update stars for day to "unlocked"
            let memberRows = document.getElementsByClassName("mem-row");
            for (let i = 0; i < memberRows.length; i++) {
                let innerSpans = memberRows[i].children;
                //index 0 is position
                //index 1 is score
                //index 2-27 are stars
                innerSpans[dateToUpdate + 1].classList.remove('privboard-star-locked');
                innerSpans[dateToUpdate + 1].classList.add('privboard-star-unlocked');
            }

        }
    }
}, 1 );

function customDateFormat(date) {// because of stupid 0 indexed months
    return date.getFullYear() + "." + (date.getMonth() + 1).toString().padStart(2, '0') + "." + date.getDate().toString().padStart(2, '0') + " " + date.getHours().toString().padStart(2, '0') + ":" + (date.getMinutes().toString().padStart(2, '0'));
}

function createDayATag(dayNumber) {
    let linkedSingleDigitATag = document.createElement("a");
    linkedSingleDigitATag.href = "https://adventofcode.com/2021/day/" + dayNumber;
    if (dayNumber < 10) {
        linkedSingleDigitATag.innerText = dayNumber;
    } else {
        let dayDigits = dayNumber.toString().split('');
        const lineBreak = document.createElement('br');
        linkedSingleDigitATag.innerHTML = dayDigits[0] + '<br>' + dayDigits[1];
    }
    return linkedSingleDigitATag
}

/**
 * Adds time to a date. Modelled after MySQL DATE_ADD function.
 * Example: dateAdd(new Date(), 'minute', 30)  //returns 30 minutes from now.
 * https://stackoverflow.com/a/1214753/18511
 * 
 * @param date  Date to start with
 * @param interval  One of: year, quarter, month, week, day, hour, minute, second
 * @param units  Number of units of the given interval to add.
 */
function dateAdd(date, interval, units) {
    if (!(date instanceof Date))
        return undefined;
    var ret = new Date(date); //don't change original date
    var checkRollover = function () { if (ret.getDate() != date.getDate()) ret.setDate(0); };
    switch (String(interval).toLowerCase()) {
        case 'year': ret.setFullYear(ret.getFullYear() + units); checkRollover(); break;
        case 'quarter': ret.setMonth(ret.getMonth() + 3 * units); checkRollover(); break;
        case 'month': ret.setMonth(ret.getMonth() + units); checkRollover(); break;
        case 'week': ret.setDate(ret.getDate() + 7 * units); break;
        case 'day': ret.setDate(ret.getDate() + units); break;
        case 'hour': ret.setTime(ret.getTime() + units * 3600000); break;
        case 'minute': ret.setTime(ret.getTime() + units * 60000); break;
        case 'second': ret.setTime(ret.getTime() + units * 1000); break;
        default: ret = undefined; break;
    }
    return ret;
}

function createMemberRows(members) {
    let containerSpan = document.createElement('span');
    // example element
    // <div id='1105834' class="privboard-row mem-row"><span class="privboard-position"> 1)</span><span class="score"> 000 </span><span class="privboard-star-unlocked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span>  <span class="privboard-name">Sarah Ball</span></div>

    for(let i = 0; i<members.length; i++){
    let outerDiv = document.createElement('div');
    outerDiv.id = members[i].id;
    outerDiv.classList.add("privboard-createMemberRows", "mem-row");
    outerDiv.innerHTML = '<span class="privboard-position"> #)</span> 000 <span class="privboard-star-locked">*</span><span class="privboard-star-unlocked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span>  <span class="privboard-name">'+members[i].name+'</span>';
    containerSpan.appendChild(outerDiv);
    }
    return containerSpan;
}
