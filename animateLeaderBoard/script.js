
const scoresJson = {"members":{"1032152":{"completion_day_level":{"4":{"2":{"get_star_ts":1638822590},"1":{"get_star_ts":1638821862}},"3":{"2":{"get_star_ts":1638734524},"1":{"get_star_ts":1638539275}},"6":{"2":{"get_star_ts":1638909999},"1":{"get_star_ts":1638909961}},"2":{"2":{"get_star_ts":1638466033},"1":{"get_star_ts":1638464807}},"5":{"2":{"get_star_ts":1638903065},"1":{"get_star_ts":1638891688}},"1":{"2":{"get_star_ts":1638393565},"1":{"get_star_ts":1638393039}}},"local_score":183,"stars":12,"name":"BurnsAndy","id":"1032152","last_star_ts":1638909999,"global_score":0},"1109424":{"last_star_ts":"0","global_score":0,"id":"1109424","local_score":0,"stars":0,"name":"Lisa Ho","completion_day_level":{}},"1031380":{"last_star_ts":1638922303,"global_score":0,"id":"1031380","local_score":157,"stars":12,"name":"deeplusplus","completion_day_level":{"4":{"1":{"get_star_ts":1638651934},"2":{"get_star_ts":1638652170}},"3":{"1":{"get_star_ts":1638575430}},"6":{"1":{"get_star_ts":1638917072},"2":{"get_star_ts":1638917087}},"7":{"1":{"get_star_ts":1638922303}},"2":{"1":{"get_star_ts":1638572713},"2":{"get_star_ts":1638573110}},"1":{"1":{"get_star_ts":1638535886},"2":{"get_star_ts":1638572067}},"5":{"2":{"get_star_ts":1638921698},"1":{"get_star_ts":1638921543}}}},"1108620":{"name":"Chris Hutchins","stars":0,"local_score":0,"completion_day_level":{},"last_star_ts":"0","global_score":0,"id":"1108620"},"1076332":{"name":"Kealy Williams","stars":9,"local_score":130,"completion_day_level":{"7":{"1":{"get_star_ts":1639103806}},"2":{"1":{"get_star_ts":1638459521}},"1":{"2":{"get_star_ts":1638380011},"1":{"get_star_ts":1638379746}},"5":{"1":{"get_star_ts":1638841804}},"4":{"2":{"get_star_ts":1638754849},"1":{"get_star_ts":1638754015}},"3":{"1":{"get_star_ts":1638746254}},"6":{"1":{"get_star_ts":1639017778}}},"last_star_ts":1639103806,"global_score":0,"id":"1076332"},"1689898":{"local_score":374,"stars":20,"name":"Peter McLarnan","completion_day_level":{"7":{"2":{"get_star_ts":1638858612},"1":{"get_star_ts":1638857100}},"2":{"1":{"get_star_ts":1638425832},"2":{"get_star_ts":1638426677}},"1":{"2":{"get_star_ts":1638416970},"1":{"get_star_ts":1638415710}},"9":{"1":{"get_star_ts":1639026763},"2":{"get_star_ts":1639031733}},"6":{"1":{"get_star_ts":1638769139},"2":{"get_star_ts":1638770370}},"8":{"1":{"get_star_ts":1638943747},"2":{"get_star_ts":1638952813}},"5":{"2":{"get_star_ts":1638689309},"1":{"get_star_ts":1638687431}},"4":{"1":{"get_star_ts":1638606808},"2":{"get_star_ts":1638607920}},"3":{"1":{"get_star_ts":1638510276},"2":{"get_star_ts":1638513637}},"10":{"1":{"get_star_ts":1639124195},"2":{"get_star_ts":1639125720}}},"global_score":0,"last_star_ts":1639125720,"id":"1689898"},"1915282":{"local_score":17,"stars":3,"name":"Lisa Ho","completion_day_level":{"1":{"2":{"get_star_ts":1639089926},"1":{"get_star_ts":1639089646}},"2":{"1":{"get_star_ts":1639090597}}},"global_score":0,"last_star_ts":1639090597,"id":"1915282"},"1108809":{"stars":4,"name":"Scott Krumrei","local_score":31,"completion_day_level":{"1":{"1":{"get_star_ts":1638583910},"2":{"get_star_ts":1638584322}},"2":{"1":{"get_star_ts":1638585499},"2":{"get_star_ts":1638586544}}},"global_score":0,"last_star_ts":1638586544,"id":"1108809"},"1105834":{"global_score":0,"last_star_ts":1639141323,"id":"1105834","local_score":351,"name":"Sarah Ball","stars":20,"completion_day_level":{"8":{"1":{"get_star_ts":1638964079},"2":{"get_star_ts":1639099463}},"5":{"2":{"get_star_ts":1638708930},"1":{"get_star_ts":1638705948}},"10":{"2":{"get_star_ts":1639141323},"1":{"get_star_ts":1639139741}},"4":{"1":{"get_star_ts":1638632343},"2":{"get_star_ts":1638633235}},"3":{"2":{"get_star_ts":1638533821},"1":{"get_star_ts":1638532084}},"2":{"2":{"get_star_ts":1638531040},"1":{"get_star_ts":1638530779}},"1":{"1":{"get_star_ts":1638361174},"2":{"get_star_ts":1638361995}},"7":{"1":{"get_star_ts":1638877430},"2":{"get_star_ts":1638879129}},"6":{"1":{"get_star_ts":1638791299},"2":{"get_star_ts":1638792889}},"9":{"1":{"get_star_ts":1639052333},"2":{"get_star_ts":1639104569}}}},"1727519":{"id":"1727519","last_star_ts":1639115229,"global_score":0,"completion_day_level":{"10":{"1":{"get_star_ts":1639114004},"2":{"get_star_ts":1639115229}},"4":{"1":{"get_star_ts":1638681139},"2":{"get_star_ts":1638681356}},"3":{"2":{"get_star_ts":1638513824},"1":{"get_star_ts":1638512313}},"5":{"2":{"get_star_ts":1638762771},"1":{"get_star_ts":1638761056}},"8":{"1":{"get_star_ts":1638976311},"2":{"get_star_ts":1638979007}},"6":{"2":{"get_star_ts":1638811208},"1":{"get_star_ts":1638811172}},"9":{"1":{"get_star_ts":1639028208},"2":{"get_star_ts":1639031472}},"2":{"1":{"get_star_ts":1638496234},"2":{"get_star_ts":1638497354}},"1":{"1":{"get_star_ts":1638454097},"2":{"get_star_ts":1638454522}},"7":{"2":{"get_star_ts":1638853947},"1":{"get_star_ts":1638853790}}},"stars":20,"name":"Murtuza Boxwala","local_score":343},"1647175":{"id":"1647175","global_score":0,"last_star_ts":1639014021,"completion_day_level":{"3":{"1":{"get_star_ts":1639014021}},"1":{"1":{"get_star_ts":1638377636},"2":{"get_star_ts":1638377963}},"2":{"2":{"get_star_ts":1638842526},"1":{"get_star_ts":1638684019}}},"stars":5,"name":"Matthew Scholand","local_score":62},"1866201":{"completion_day_level":{"1":{"1":{"get_star_ts":1638909804}}},"local_score":6,"stars":1,"name":"Guillermo Bautista","id":"1866201","last_star_ts":1638909804,"global_score":0},"1536781":{"id":"1536781","last_star_ts":1638462660,"global_score":0,"completion_day_level":{"2":{"2":{"get_star_ts":1638462660},"1":{"get_star_ts":1638459485}},"1":{"2":{"get_star_ts":1638378029},"1":{"get_star_ts":1638372149}}},"local_score":73,"name":"MitchZo","stars":4},"1624251":{"stars":7,"name":"tone-segura","local_score":95,"completion_day_level":{"3":{"1":{"get_star_ts":1638509999},"2":{"get_star_ts":1639013503}},"4":{"1":{"get_star_ts":1639020974}},"1":{"2":{"get_star_ts":1638484539},"1":{"get_star_ts":1638467656}},"2":{"1":{"get_star_ts":1638485186},"2":{"get_star_ts":1638485400}}},"last_star_ts":1639020974,"global_score":0,"id":"1624251"},"1221136":{"global_score":0,"last_star_ts":1639119768,"id":"1221136","stars":14,"name":"George Lund","local_score":206,"completion_day_level":{"3":{"2":{"get_star_ts":1638647947},"1":{"get_star_ts":1638589885}},"6":{"2":{"get_star_ts":1638938370},"1":{"get_star_ts":1638938339}},"10":{"2":{"get_star_ts":1639119768},"1":{"get_star_ts":1639118314}},"7":{"1":{"get_star_ts":1638929146},"2":{"get_star_ts":1638930923}},"8":{"2":{"get_star_ts":1639112861},"1":{"get_star_ts":1639018522}},"1":{"1":{"get_star_ts":1638410302},"2":{"get_star_ts":1638411032}},"2":{"2":{"get_star_ts":1638499454},"1":{"get_star_ts":1638498901}}}},"1624263":{"id":"1624263","last_star_ts":1638933816,"global_score":0,"completion_day_level":{"2":{"2":{"get_star_ts":1638458153},"1":{"get_star_ts":1638457397}},"1":{"2":{"get_star_ts":1638380859},"1":{"get_star_ts":1638379104}},"5":{"1":{"get_star_ts":1638769705}},"7":{"1":{"get_star_ts":1638933816}},"6":{"1":{"get_star_ts":1638824102},"2":{"get_star_ts":1638931149}},"4":{"2":{"get_star_ts":1638601095},"1":{"get_star_ts":1638600184}},"3":{"2":{"get_star_ts":1638589861},"1":{"get_star_ts":1638540594}}},"name":"wwestfall91","stars":12,"local_score":204},"1236060":{"last_star_ts":"0","global_score":0,"id":"1236060","stars":0,"name":"Giovanni Sturla","local_score":0,"completion_day_level":{}},"1632578":{"id":"1632578","global_score":0,"last_star_ts":1638486997,"completion_day_level":{"1":{"2":{"get_star_ts":1638410800},"1":{"get_star_ts":1638408568}},"2":{"2":{"get_star_ts":1638486997},"1":{"get_star_ts":1638486163}}},"stars":4,"name":"JD","local_score":57},"1666139":{"global_score":0,"last_star_ts":"0","id":"1666139","local_score":0,"stars":0,"name":null,"completion_day_level":{}},"532224":{"id":"532224","global_score":0,"last_star_ts":1638967737,"completion_day_level":{"6":{"2":{"get_star_ts":1638917120},"1":{"get_star_ts":1638851847}},"7":{"1":{"get_star_ts":1638883097},"2":{"get_star_ts":1638929101}},"2":{"2":{"get_star_ts":1638500282},"1":{"get_star_ts":1638500045}},"1":{"1":{"get_star_ts":1638450048},"2":{"get_star_ts":1638507128}},"4":{"1":{"get_star_ts":1638675196}},"3":{"1":{"get_star_ts":1638572541},"2":{"get_star_ts":1638577063}},"8":{"1":{"get_star_ts":1638967737}},"5":{"1":{"get_star_ts":1638841738}}},"local_score":189,"stars":13,"name":"UncleTed"}},"owner_id":"1031380","event":"2021"}

function parseMember() {
    //objects I THINK I might need to go for - ultimately scores and position will need to be calculated as I go based on starDates to animate...
    // membersArray = [
    //         {
    //             id: 1234,
    //             name: 'Sarah"',
    //         }
    //     ]
    // starDates = [
    //     {
    //         timestamp: new Date(),
    //         memberId: '1234' //so I can find the right element
    //         star: [day, part]
    //     }
    // ]

    let membersArray = [];
    let starDates = [];
    let tempMember;
    let tempStars;
    for (entry in scoresJson.members) {
        tempMember = scoresJson.members[entry];
        membersArray.push({
            id: tempMember.id,
            name: tempMember.name
        });

        tempStars = scoresJson.members[entry].completion_day_level
        for (star in tempStars) {
            for (part in tempStars[star]) {
                starDates.push({
                    timestamp: new Date(tempStars[star][part].get_star_ts * 1000), //used https://www.reddit.com/r/adventofcode/comments/a4ma4o/private_leaderboard_star_times_display to figure out how the date/time should be parsed
                    memberId: tempMember.id,
                    star: [parseInt(star), parseInt(part)]
                });
            }
        }
    }

    return [membersArray, starDates];
}

let parsed = parseMember();
let members = parsed[0];
let stardates = parsed[1].sort((first, second) => (first.timestamp < second.timestamp ? 1 : -1));
let memberNumber = members.length;
let starscores = generateInitialStarValues(memberNumber);
let memberScores = initializeMemberScores(members);

console.log(stardates);

let countDownTime = new Date('December 1, 2021 01:00:00');
let countDownStop = Date.now();

let dateChange = false;
let runOnce = true;

let countdown = setInterval(function () {
    if (runOnce) { //hack - I'll deal with it later...
        runOnce = false;
        let newElement = createMemberRows(members)
        let memberRows = document.getElementById("member-rows");
        memberRows.parentNode.replaceChild(newElement, memberRows);
        console.log(memberScores);
    }

    if (countDownTime < countDownStop) {
        let newDate = dateAdd(countDownTime, 'minute', 5);
        dateChange = newDate.getDate() != countDownTime.getDate();
        countDownTime = newDate
        document.getElementById("countdown").innerHTML = customDateFormat(countDownTime);

        if (dateChange) {
            dateChange = false;
            let dateToUpdate = countDownTime.getDate();

            //Update links of numbers
            let linkedSingleDigitATag = createDayATag(dateToUpdate)
            let parentRowElement = document.getElementsByClassName("privboard-days");
            let elementToUpdate = parentRowElement[0].children[dateToUpdate - 1]; //index off by one
            elementToUpdate.parentNode.replaceChild(linkedSingleDigitATag, elementToUpdate);

            //Update stars for day to "unlocked"
            let memberRows = document.getElementsByClassName("mem-row");
            for (let i = 0; i < memberRows.length; i++) {
                let innerSpans = memberRows[i].children;
                //index 0 is position
                //index 1 is score
                //index 2-27 are stars
                innerSpans[dateToUpdate + 2].classList.remove('privboard-star-locked');
                innerSpans[dateToUpdate + 2].classList.add('privboard-star-unlocked');
            }
        }

        //while last item in stardate is less than current time
        while (stardates.length > 0 &&
            stardates[stardates.length - 1].timestamp < countDownTime) {
            let singleStarDate = stardates[stardates.length - 1];
            let memberRow = document.getElementById(singleStarDate.memberId);

            //----------------------------update star----------------------------
            let innerSpans = memberRow.children;
            //index 0 is position
            //index 1 is score
            //index 2-27 are stars

            let dayOfStar = singleStarDate.star[0];
            let part1Or2 = singleStarDate.star[1];
            let starSpan = innerSpans[dayOfStar + 2];
            if (part1Or2 == "1") {
                starSpan.classList.remove('privboard-star-unlocked');
                starSpan.classList.add('privboard-star-firstonly');
            } else {
                starSpan.classList.remove('privboard-star-firstonly');
                starSpan.classList.add('privboard-star-both');
            }

            //----------------------------update score----------------------------
            let priorScore = memberScores[singleStarDate.memberId];
            let pointsForNewStar = starscores[dayOfStar + '.' + part1Or2];
            let newScore = priorScore + pointsForNewStar;
            memberScores[singleStarDate.memberId] = newScore;

            innerSpans[1].innerHTML = paddedScores(newScore);
            starscores[dayOfStar + '.' + part1Or2] = pointsForNewStar - 1; //deincrement for next winner
            stardates.pop();

            //----------------------------sort rows----------------------------
            memberRow.before()
        }
    }
}, 1);


function paddedScores(value) {
    switch (value.toString().length) {
        case 3:
            return "&nbsp" + value + "&nbsp";
        case 2:
            return "&nbsp&nbsp" + value + "&nbsp";
        case 1:
            return "&nbsp&nbsp&nbsp" + value + "&nbsp";
        default:
            return "Bad score value";
    }
}

function customDateFormat(date) {
    return date.getFullYear() + "." + (date.getMonth() + 1).toString().padStart(2, '0') + "." + date.getDate().toString().padStart(2, '0') + " " + date.getHours().toString().padStart(2, '0') + ":" + (date.getMinutes().toString().padStart(2, '0'));
}//                                                      ^because of stupid 0 indexed months

function createDayATag(dayNumber) {
    let linkedSingleDigitATag = document.createElement("a");
    linkedSingleDigitATag.href = "https://adventofcode.com/2021/day/" + dayNumber;
    if (dayNumber < 10) {
        linkedSingleDigitATag.innerText = dayNumber;
    } else {
        let dayDigits = dayNumber.toString().split('');
        const lineBreak = document.createElement('br');
        linkedSingleDigitATag.innerHTML = dayDigits[0] + '<br>' + dayDigits[1];
    }
    return linkedSingleDigitATag
}

/**
 * Adds time to a date. Modelled after MySQL DATE_ADD function.
 * Example: dateAdd(new Date(), 'minute', 30)  //returns 30 minutes from now.
 * https://stackoverflow.com/a/1214753/18511
 * 
 * @param date  Date to start with
 * @param interval  One of: year, quarter, month, week, day, hour, minute, second
 * @param units  Number of units of the given interval to add.
 */
function dateAdd(date, interval, units) {
    if (!(date instanceof Date))
        return undefined;
    var ret = new Date(date); //don't change original date
    var checkRollover = function () { if (ret.getDate() != date.getDate()) ret.setDate(0); };
    switch (String(interval).toLowerCase()) {
        case 'year': ret.setFullYear(ret.getFullYear() + units); checkRollover(); break;
        case 'quarter': ret.setMonth(ret.getMonth() + 3 * units); checkRollover(); break;
        case 'month': ret.setMonth(ret.getMonth() + units); checkRollover(); break;
        case 'week': ret.setDate(ret.getDate() + 7 * units); break;
        case 'day': ret.setDate(ret.getDate() + units); break;
        case 'hour': ret.setTime(ret.getTime() + units * 3600000); break;
        case 'minute': ret.setTime(ret.getTime() + units * 60000); break;
        case 'second': ret.setTime(ret.getTime() + units * 1000); break;
        default: ret = undefined; break;
    }
    return ret;
}

function createMemberRows(members) {
    let containerSpan = document.createElement('span');
    // example element
    // <div id='1105834' class="privboard-row mem-row"><span class="privboard-position"> 1)</span><span class="score"> 000 </span><span class="privboard-star-unlocked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span>  <span class="privboard-name">Sarah Ball</span></div>

    for (let i = 0; i < members.length; i++) {
        //Hailey case
        if(members[i].id == '1666139'){
            members[i].name = "Hailey Quinn";
        }
        let outerDiv = document.createElement('div');
        outerDiv.id = members[i].id;
        outerDiv.classList.add("privboard-createMemberRows", "mem-row");
        outerDiv.innerHTML = '<span class="privboard-position"> #)</span><span>&nbsp&nbsp&nbsp0&nbsp</span><span class="privboard-star-locked">*</span><span class="privboard-star-unlocked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span><span class="privboard-star-locked">*</span>  <span class="privboard-name">' + members[i].name + '</span>';
        containerSpan.appendChild(outerDiv);
    }
    return containerSpan;
}

function initializeMemberScores(members) {
    let scores = {};
    for (let i = 0; i < members.length; i++) {
        scores[members[i].id] = 0;
    }
    return scores;
}

function generateInitialStarValues(memberNumber) {
    return {
        '1.1': memberNumber,
        '2.1': memberNumber,
        '3.1': memberNumber,
        '4.1': memberNumber,
        '5.1': memberNumber,
        '6.1': memberNumber,
        '7.1': memberNumber,
        '8.1': memberNumber,
        '9.1': memberNumber,
        '10.1': memberNumber,
        '11.1': memberNumber,
        '12.1': memberNumber,
        '13.1': memberNumber,
        '14.1': memberNumber,
        '15.1': memberNumber,
        '16.1': memberNumber,
        '17.1': memberNumber,
        '18.1': memberNumber,
        '19.1': memberNumber,
        '20.1': memberNumber,
        '21.1': memberNumber,
        '22.1': memberNumber,
        '23.1': memberNumber,
        '24.1': memberNumber,
        '25.1': memberNumber,
        '1.2': memberNumber,
        '2.2': memberNumber,
        '3.2': memberNumber,
        '4.2': memberNumber,
        '5.2': memberNumber,
        '6.2': memberNumber,
        '7.2': memberNumber,
        '8.2': memberNumber,
        '9.2': memberNumber,
        '10.2': memberNumber,
        '11.2': memberNumber,
        '12.2': memberNumber,
        '13.2': memberNumber,
        '14.2': memberNumber,
        '15.2': memberNumber,
        '16.2': memberNumber,
        '17.2': memberNumber,
        '18.2': memberNumber,
        '19.2': memberNumber,
        '20.2': memberNumber,
        '21.2': memberNumber,
        '22.2': memberNumber,
        '23.2': memberNumber,
        '24.2': memberNumber,
        '25.2': memberNumber
    }
}
